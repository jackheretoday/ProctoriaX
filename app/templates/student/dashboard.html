{% extends "student/base_student.html" %}

{% block student_content %}
<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .section {
        margin-bottom: 30px;
        background: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--card-border);
    }
    .section h3 {
        color: var(--color-text);
        margin-bottom: 20px;
        border-bottom: 2px solid var(--color-primary);
        padding-bottom: 10px;
    }
    .test-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    .test-card {
        background: var(--card-bg-alt);
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid var(--color-primary);
        transition: transform 0.2s;
        border: 1px solid var(--card-border);
    }
    .test-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-hover-shadow);
    }
    .test-card h4 {
        color: var(--color-text);
        margin-bottom: 15px;
    }
    .test-card p {
        margin: 5px 0;
        color: var(--color-text-secondary);
    }
    .test-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .test-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: var(--card-bg-alt);
        border-radius: 8px;
        border-left: 4px solid var(--color-success);
        transition: transform 0.2s;
        border: 1px solid var(--card-border);
    }
    .test-list-item:hover {
        transform: translateX(5px);
        background: var(--card-bg-hover);
    }
    .test-info {
        flex: 1;
    }
    .test-name-with-score {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 8px;
    }
    .test-meta {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
    }
    .test-meta small {
        color: var(--color-text-secondary);
    }
    .test-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .score-badge {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9rem;
        white-space: nowrap;
    }
    .score-excellent { background: var(--color-success); color: white; }
    .score-good { background: var(--color-info); color: white; }
    .score-average { background: var(--color-warning); color: var(--color-text); }
    .score-poor { background: var(--color-danger); color: white; }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 10px;
        }
        
        .test-cards {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .test-list-item {
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
        }
        
        .test-info {
            width: 100%;
            margin-bottom: 15px;
        }
        
        .test-name-with-score {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .test-name-with-score strong {
            font-size: 1rem;
            line-height: 1.3;
        }
        
        .test-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            margin-top: 8px;
        }
        
        .test-meta small {
            font-size: 0.8rem;
        }
        
        .test-actions {
            width: 100%;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }
        
        .test-actions a {
            flex: 1;
            text-align: center;
            padding: 8px 12px;
            font-size: 0.85rem;
        }
        
        .btn-review {
            background: var(--color-primary);
            color: white;
            border-radius: 6px;
            text-decoration: none;
            padding: 8px 12px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .btn-review:hover {
            background: var(--color-primary-dark);
            color: white;
            text-decoration: none;
        }
        
        .score-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            align-self: flex-start;
        }
    }
    
    @media (max-width: 480px) {
        .section {
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .test-list-item {
            padding: 12px;
        }
        
        .test-actions {
            flex-direction: column;
            gap: 8px;
        }
        
        .test-actions a {
            width: 100%;
        }
        
        .section h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
    }
    .btn-review {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s;
        display: inline-block;
    }
    
    .btn-review:hover {
        background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-accent-dark) 100%);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--color-text-secondary);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .empty-state p {
        margin: 0;
        font-size: 1.1rem;
    }
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .summary-card {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        transition: transform 0.2s;
    }
    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    .summary-icon {
        font-size: 2rem;
        opacity: 0.9;
    }
    .summary-content {
        flex: 1;
    }
    .summary-number {
        font-size: 1.8rem;
        font-weight: bold;
        line-height: 1;
    }
    .summary-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 5px;
    }
    
    /* Dark mode specific fixes */
    [data-bs-theme="dark"] .test-card {
        background: var(--card-bg-alt);
        border-color: var(--card-border);
    }
    
    [data-bs-theme="dark"] .test-list-item {
        background: var(--card-bg-alt);
        border-color: var(--card-border);
    }
    
    [data-bs-theme="dark"] .test-list-item:hover {
        background: var(--card-bg-hover);
    }
    
    [data-bs-theme="dark"] .test-card h4,
    [data-bs-theme="dark"] .test-info strong {
        color: var(--color-text);
    }
    
    [data-bs-theme="dark"] .test-card p,
    [data-bs-theme="dark"] .test-meta small {
        color: var(--color-text-secondary);
    }
    
    [data-bs-theme="dark"] .empty-state {
        color: var(--color-text-secondary);
    }
    
    [data-bs-theme="dark"] .empty-state i {
        color: var(--color-text-muted);
    }
    
    [data-bs-theme="dark"] .section h3 {
        color: var(--color-text);
    }
    
    /* Badge dark mode fixes */
    [data-bs-theme="dark"] .badge {
        background-color: var(--color-primary);
        color: white;
    }
    
    [data-bs-theme="dark"] .badge.bg-success {
        background-color: var(--color-success) !important;
    }
    
    [data-bs-theme="dark"] .badge.bg-warning {
        background-color: var(--color-warning) !important;
        color: var(--color-text) !important;
    }
    
    [data-bs-theme="dark"] .badge.bg-info {
        background-color: var(--color-info) !important;
    }
    
    [data-bs-theme="dark"] .badge.bg-danger {
        background-color: var(--color-danger) !important;
    }
    
    /* Button dark mode fixes */
    [data-bs-theme="dark"] .btn {
        border-color: var(--color-border);
    }
    
    [data-bs-theme="dark"] .btn-info {
        background-color: var(--color-info);
        border-color: var(--color-info);
    }
    
    [data-bs-theme="dark"] .btn-info:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    
    /* Text fixes for dark mode */
    [data-bs-theme="dark"] .text-muted {
        color: var(--color-text-secondary) !important;
    }
    
    [data-bs-theme="dark"] h2 {
        color: var(--color-text) !important;
    }
    
    /* Summary card dark mode fixes */
    [data-bs-theme="dark"] .summary-card {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
    }
    
    /* Ensure all test items have proper dark mode styling */
    [data-bs-theme="dark"] .test-name-with-score strong {
        color: var(--color-text);
    }
    
    [data-bs-theme="dark"] .test-name-with-score {
        color: var(--color-text);
    }
</style>

<div class="dashboard-container">
    <h2>Welcome, {{ current_user.full_name or current_user.username }}!</h2>
    <p class="text-muted">Today's Date: {{ today.strftime('%B %d, %Y') }}</p>
    
    <!-- Performance Summary -->
    {% if past_tests %}
    {% set completed_tests = past_tests | selectattr('result') | list %}
    {% if completed_tests %}
    <div class="section">
        <h3><i class="fas fa-chart-line me-2"></i>Performance Summary</h3>
        <div class="summary-cards">
            {% set total_completed = completed_tests | length %}
            {% set avg_score = (completed_tests | map(attribute='result') | map(attribute='percentage') | sum / total_completed) %}
            {% set best_score = (completed_tests | map(attribute='result') | map(attribute='percentage') | max) %}
            {% set total_questions = (completed_tests | map(attribute='result') | map(attribute='total_questions') | sum) %}
            {% set total_correct = (completed_tests | map(attribute='result') | map(attribute='correct_answers') | sum) %}
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number">{{ total_completed }}</div>
                    <div class="summary-label">Tests Completed</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number">{{ avg_score | round(1) }}%</div>
                    <div class="summary-label">Average Score</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number">{{ best_score | round(1) }}%</div>
                    <div class="summary-label">Best Score</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number">{{ total_correct }}/{{ total_questions }}</div>
                    <div class="summary-label">Total Correct</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
    
    <!-- Today's Tests -->
    <div class="section">
        <h3><i class="fas fa-calendar-day me-2"></i>Today's Assigned Tests</h3>
        {% if todays_tests %}
            <div class="test-cards">
                {% for test in todays_tests %}
                <div class="test-card">
                    <h4>{{ test.name }}</h4>
                    <p><strong><i class="fas fa-book me-1"></i>Subject:</strong> {{ test.subject }}</p>
                    <p><strong><i class="fas fa-clock me-1"></i>Duration:</strong> {{ test.duration }} minutes</p>
                    {% if test.result %}
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>Completed</span>
                        <div class="mt-2">
                            <span class="badge bg-info">{{ test.result.percentage|round(1) }}%</span>
                        </div>
                        <div class="mt-2">
                            <a href="{{ url_for('student.test_result', test_id=test.id) }}" class="btn btn-info btn-sm">
                                <i class="fas fa-chart-bar me-1"></i>View Results
                            </a>
                            <a href="{{ url_for('student.review_answers', test_id=test.id) }}" class="btn btn-sm btn-outline-primary ms-1">
                                <i class="fas fa-eye me-1"></i>Review
                            </a>
                        </div>
                    {% else %}
                        <span class="badge bg-warning"><i class="fas fa-hourglass-half me-1"></i>Pending</span>
                        <a href="{{ url_for('student.test_instructions', test_id=test.id) }}" class="btn btn-primary mt-2">
                            <i class="fas fa-play me-1"></i>Start Test
                        </a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <p>No tests assigned for today</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Upcoming Tests -->
    <div class="section">
        <h3><i class="fas fa-calendar-alt me-2"></i>Upcoming Tests</h3>
        {% if upcoming_tests %}
            <div class="test-list">
                {% for test in upcoming_tests %}
                <div class="test-list-item">
                    <div class="test-info">
                        <strong>{{ test.name }}</strong> - {{ test.subject }}
                        <div class="test-meta">
                            <small><i class="fas fa-calendar me-1"></i>Scheduled: {{ test.assigned_date.strftime('%B %d, %Y') }}</small>
                            <small><i class="fas fa-clock me-1"></i>{{ test.duration }} minutes</small>
                        </div>
                    </div>
                    <span class="badge bg-info"><i class="fas fa-hourglass-half me-1"></i>Upcoming</span>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-check"></i>
                <p>No upcoming tests</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Past Tests -->
    <div class="section">
        <h3><i class="fas fa-history me-2"></i>Past Tests</h3>
        {% if past_tests %}
            <div class="test-list">
                {% for test in past_tests %}
                <div class="test-list-item">
                    <div class="test-info">
                        <div class="test-name-with-score">
                            <strong>{{ test.name }}</strong> - {{ test.subject }}
                            {% if test.result %}
                                {% set percentage = test.result.percentage %}
                                {% if percentage >= 80 %}
                                    {% set score_class = 'score-excellent' %}
                                {% elif percentage >= 60 %}
                                    {% set score_class = 'score-good' %}
                                {% elif percentage >= 40 %}
                                    {% set score_class = 'score-average' %}
                                {% else %}
                                    {% set score_class = 'score-poor' %}
                                {% endif %}
                                
                                <span class="score-badge {{ score_class }}">
                                    {{ percentage|round(1) }}%
                                </span>
                            {% endif %}
                        </div>
                        {% if test.result %}
                        <div class="test-meta">
                            <small><i class="fas fa-calendar me-1"></i>Completed: {{ test.result.completed_at.strftime('%B %d, %Y') }}</small>
                            <small><i class="fas fa-clock me-1"></i>Time: {% if test.result.time_taken %}{{ (test.result.time_taken / 60)|round(1) }}{% else %}0{% endif %} minutes</small>
                            <small><i class="fas fa-question-circle me-1"></i>{{ test.result.total_questions }} questions</small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="test-actions">
                        {% if test.result %}
                            <a href="{{ url_for('student.review_answers', test_id=test.id) }}" class="btn-review">
                                <i class="fas fa-eye me-1"></i>Review Answers
                            </a>
                            
                            <a href="{{ url_for('student.test_result', test_id=test.id) }}" class="btn btn-info btn-sm">
                                <i class="fas fa-chart-bar me-1"></i>Results
                            </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <p>No past tests</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}